# Task: 画面オフ時アラーム後の初回ロック解除 遷移判定

## 目的
画面オフ中にタイマー通知（アラーム）が発火したケースで、通知未タップ時の遷移を安定化する。

## 合意済み仕様
- 画面オフ中にタイマー通知（アラーム）が発火した場合、以後最初に行われる端末ロック解除を起点として遷移判定を行う。
- 解除直後にホームとして表示される画面は、その時点の結界状態に応じて、若様ホームまたは通常ホームのいずれか一方に確定する。
- この「最初のロック解除」判定は1回限り有効とし、判定消費後は若様アプリの既存ホーム遷移ルール（現行仕様）に復帰する。

## 通知導線の切り分け
- 通知タップ解除: 既存導線を優先（今回変更なし）。
- 通知無視解除: 今回追加する未タップ時フォールバックを適用。

## 判定優先順（高 -> 低）
1. `G0` 既定ホーム前提ガード
2. `G1` ホーム設定導線ガード
3. `R0` 通知タップ起動ガード（既存優先）
4. `R1` 通知無視・初回ロック解除判定（新規、1回消費）
5. `R2` 保存直後1回ルール（既存）
6. `R3` 通常ホーム遷移ルール（既存）
7. `END` 若様ホーム維持（既定終端）

## 受け入れ条件（テスト観点）
1. 通知タップ導線は現状維持
2. 通知無視時の初回解除で分岐（結界ON）
3. 通知無視時の初回解除で分岐（結界OFF）
4. 初回判定は1回限り
5. 通知無視フォールバック限定
6. 非対象ケースは影響なし（画面オン中発火）
7. 既定ホーム前提ガード
8. ホーム設定導線中ガード
9. 通知無視判定の厳密性（起動経路差異に依存しない）
10. 回帰確認（既存重要導線）

## AC -> 判定マッピング
- AC1 -> `R0`
- AC2 -> `R1`（結果: 若様ホーム）
- AC3 -> `R1`（結果: 通常ホーム）
- AC4 -> `R1` の1回消費 + 以降 `R2/R3`
- AC5 -> `R0` と `R1` を排他
- AC6 -> `R1` の事前条件で除外
- AC7 -> `G0`
- AC8 -> `G1`
- AC9 -> `R1`
- AC10 -> `R2/R3` の既存挙動維持

## 実装時の注意
- `R1` の消費箇所は1か所に固定する。
- `R1` 実行後は必ず既存ルールへ復帰する。
- `HOME/LAUNCHER/OTHER` 判定と新規判定の責務を混在させない。

## 変更記録
- 2026-02-22: `ACTION_USER_PRESENT` 依存の受信判定を廃止した。
  - 背景受信制限（`Background execution not allowed`）で端末依存の取りこぼしが発生するため。
  - `R1` の実行/消費は `MainActivity.applyPendingUnlockDecisionIfNeeded` に一本化。
  - 通知未タップ時の初回解除判定は、HOME復帰時の `onCreate/onResume/onNewIntent` で評価する。
